generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  SUPORTE
  OPERADOR
  CAIXA
}

enum CaixaStatus {
  ABERTO
  FECHADO
}

enum MovimentoTipo {
  ABERTURA
  VENDA
  SANGRIA
  SUPRIMENTO
  FECHAMENTO
}

enum FormaPagamento {
  DINHEIRO
  CARTAO
  PIX
  MISTO
}

enum PaymentTipo {
  DINHEIRO
  PIX
  CARTAO_CREDITO
  CARTAO_DEBITO
}

enum VendaStatus {
  CONCLUIDA
  CANCELADA
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  BLOCKED
}

enum LicensePlanType {
  MONTHLY
  ANNUAL
  LIFETIME
}

model User {
  id              String               @id @default(uuid())
  nome            String
  email           String               @unique
  senhaHash       String
  role            Role                 @default(CAIXA)
  ativo           Boolean              @default(true)
  tentativasLogin Int                  @default(0)
  bloqueadoAte    DateTime?
  ultimoLogin     DateTime?
  criadoEm        DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  refreshTokens   RefreshToken[]
  auditLogs       AuditLog[]
  passwordResets  PasswordResetToken[]
  caixas          Caixa[]
  vendas          Venda[]
  movimentosCaixa CaixaMovimento[]
  licenses        License[]
}

model RefreshToken {
  id               String    @id @default(uuid())
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash        String    @unique
  expiraEm         DateTime
  criadoEm         DateTime  @default(now())
  revogado         Boolean   @default(false)
  revogadoEm       DateTime?
  revogadoMotivo   String?
  substituidoPorId String?
  ip               String?
  userAgent        String?

  @@index([userId])
  @@index([expiraEm])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  acao      String
  ip        String?
  userAgent String?
  criadoEm  DateTime @default(now())

  @@index([userId])
  @@index([acao])
  @@index([criadoEm])
}

model TokenBlacklist {
  id        String   @id @default(uuid())
  tokenHash String   @unique
  expiraEm  DateTime
  criadoEm  DateTime @default(now())

  @@index([expiraEm])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String   @unique
  expiraEm  DateTime
  usadoEm   DateTime?
  criadoEm  DateTime @default(now())

  @@index([userId])
  @@index([expiraEm])
}

model License {
  id          String              @id @default(uuid())
  licenseKey  String              @unique
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Restrict)
  status      LicenseStatus       @default(ACTIVE)
  planType    LicensePlanType
  maxDevices  Int
  createdAt   DateTime            @default(now())
  expiresAt   DateTime?
  updatedAt   DateTime            @updatedAt
  activations LicenseActivation[]
  history     LicenseHistory[]

  @@index([status, createdAt])
  @@index([userId, status])
  @@index([expiresAt])
}

model LicenseActivation {
  id          String   @id @default(uuid())
  licenseId   String
  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  deviceId    String
  activatedAt DateTime @default(now())
  lastCheck   DateTime @default(now())

  @@unique([licenseId, deviceId])
  @@index([licenseId, lastCheck])
}

model LicenseHistory {
  id          String   @id @default(uuid())
  licenseId   String
  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)
  action      String
  performedBy String
  createdAt   DateTime @default(now())

  @@index([licenseId, createdAt])
  @@index([action, createdAt])
}

model Caixa {
  id                      String           @id @default(uuid())
  operadorId              String
  operador                User             @relation(fields: [operadorId], references: [id], onDelete: Restrict)
  status                  CaixaStatus      @default(ABERTO)
  valorInicial            Decimal          @db.Decimal(10, 2)
  aberturaEm              DateTime         @default(now())
  fechamentoEm            DateTime?
  valorEsperadoFechamento Decimal?         @db.Decimal(10, 2)
  valorContadoFechamento  Decimal?         @db.Decimal(10, 2)
  diferencaFechamento     Decimal?         @db.Decimal(10, 2)
  justificativaDivergencia String?
  vendas                  Venda[]
  movimentos              CaixaMovimento[]

  @@index([operadorId, status])
  @@index([status, aberturaEm])
}

model CaixaMovimento {
  id             String          @id @default(uuid())
  caixaId        String
  caixa          Caixa           @relation(fields: [caixaId], references: [id], onDelete: Cascade)
  operadorId     String
  operador       User            @relation(fields: [operadorId], references: [id], onDelete: Restrict)
  tipo           MovimentoTipo
  valor          Decimal         @db.Decimal(10, 2)
  formaPagamento FormaPagamento?
  descricao      String?
  referenciaVenda String?
  venda          Venda?          @relation(fields: [referenciaVenda], references: [id], onDelete: SetNull)
  criadoEm       DateTime        @default(now())

  @@index([caixaId, criadoEm])
  @@index([operadorId, criadoEm])
  @@index([tipo, criadoEm])
}

model Fornecedor {
  id           String      @id @default(uuid())
  nome         String
  cnpj         String?
  email        String?
  telefone     String?
  endereco     String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  produtos     Produto[]
}

model Categoria {
  id        String    @id @default(uuid())
  nome      String    @unique
  createdAt DateTime  @default(now())
  produtos  Produto[]
}

model Produto {
  id            String      @id @default(uuid())
  nome          String
  codigo        String?     @unique
  preco         Decimal     @db.Decimal(10, 2)
  estoque       Int         @default(0)
  categoriaId   String?
  categoria     Categoria?  @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  fornecedorId  String?
  fornecedor    Fornecedor? @relation(fields: [fornecedorId], references: [id], onDelete: SetNull)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  itensVenda    ItemVenda[]
}

model Venda {
  id               String          @id @default(uuid())
  caixaId          String
  caixa            Caixa           @relation(fields: [caixaId], references: [id], onDelete: Restrict)
  operadorId       String
  operador         User            @relation(fields: [operadorId], references: [id], onDelete: Restrict)
  subtotal         Decimal         @db.Decimal(10, 2)
  desconto         Decimal         @default(0) @db.Decimal(10, 2)
  total            Decimal         @db.Decimal(10, 2)
  cpf              String?
  cliente          String?
  observacao       String?
  formaPagamento   FormaPagamento  @default(DINHEIRO)
  pagamentoDetalhe Json?
  status           VendaStatus     @default(CONCLUIDA)
  createdAt        DateTime        @default(now())
  itens            ItemVenda[]
  pagamentos       Payment[]
  movimentos       CaixaMovimento[]

  @@index([caixaId, createdAt])
  @@index([operadorId, createdAt])
}

model ItemVenda {
  id         String  @id @default(uuid())
  vendaId    String
  venda      Venda   @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produtoId  String
  produto    Produto @relation(fields: [produtoId], references: [id], onDelete: Restrict)
  quantidade Int
  precoUnit  Decimal @db.Decimal(10, 2)
  subtotal   Decimal @db.Decimal(10, 2)

  @@unique([vendaId, produtoId])
}

model Payment {
  id        String      @id @default(uuid())
  vendaId   String
  venda     Venda       @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  tipo      PaymentTipo
  valor     Decimal     @db.Decimal(10, 2)
  parcelas  Int?
  troco     Decimal?    @db.Decimal(10, 2)
  criadoEm  DateTime    @default(now())

  @@index([vendaId, criadoEm])
}
